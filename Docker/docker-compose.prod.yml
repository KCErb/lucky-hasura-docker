version: '3.6'
services:
  postgres:
    environment:
      - POSTGRES_PASSWORD
      - POSTGRES_USER
      - POSTGRES_DB
    # HTTPS_SWITCH
    volumes:
    - /home/docker/data:/data
    deploy:
      placement:
        constraints: [node.role == manager]
    networks:
    - internal
    - migrations
  hasura:
    environment:
      HASURA_GRAPHQL_ADMIN_SECRET:
      POSTGRES_USER:
      POSTGRES_PASSWORD:
      POSTGRES_DB:
      HASURA_GRAPHQL_DATABASE_URL: "postgres://$POSTGRES_USER:$POSTGRES_PASSWORD@postgres:5432/$POSTGRES_DB"
    healthcheck:
      test: ["CMD", "/script/docker/hasura_healthcheck"]
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
    networks:
    - internal
  lucky:
    build:
      context: ../
      dockerfile: Docker/lucky/Dockerfile.prod
      cache_from:
        - $REGISTRY_IMAGE:$CI_COMMIT_REF_NAME
    image: registry.gitlab.com/GITLAB_USER/GITLAB_REPO_NAME/lucky:${LUCKY_TAG}
    environment:
      POSTGRES_USER:
      POSTGRES_PASSWORD:
      POSTGRES_DB:
      SECRET_KEY_BASE:
      SEND_GRID_KEY:
      APP_DOMAIN:
      LUCKY_ENV:
      PORT: 5000
      DATABASE_URL: "postgres://$POSTGRES_USER:$POSTGRES_PASSWORD@postgres:5432/$POSTGRES_DB"
    healthcheck:
      test: ["CMD", "/data/script/docker/lucky_healthcheck"]
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
    networks:
    - internal
    - migrations

networks:
  internal:
  migrations:
    driver: overlay
    attachable: true
